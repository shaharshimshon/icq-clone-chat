
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ICQ Clone</title>
  <style>
    body { font-family: sans-serif; background: #eef2f5; margin: 0; padding: 0; }
    .container { max-width: 600px; margin: auto; padding: 20px; }
    .auth, .chat, .profile { margin-bottom: 20px; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    .message { margin: 10px 0; padding: 10px; background: #fff; border-radius: 5px; display: flex; align-items: center; }
    .message img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .hidden { display: none; }
    #chat-box { max-height: 300px; overflow-y: auto; background: #fff; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="auth">
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button id="register-btn">Register</button>
      <button id="login-btn">Login</button>
      <button id="logout-btn" class="hidden">Logout</button>
    </div>

    <div class="profile hidden">
      <input id="display-name" type="text" placeholder="Display Name">
      <input id="profile-photo" type="file" accept="image/*">
      <button id="update-profile-btn">Update Profile</button>
    </div>

    <div class="chat hidden">
      <div id="chat-box"></div>
      <input id="message" type="text" placeholder="Type a message...">
      <button id="send-btn">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDHZpDfKz711k2agTq4ekGU7-iN_p99mc",
      authDomain: "icqclone.firebaseapp.com",
      projectId: "icqclone",
      storageBucket: "icqclone.appspot.com",
      messagingSenderId: "922649039358",
      appId: "1:922649039358:web:fbdd0a0e21d64e4d32f0af",
      measurementId: "G-HHJ3S1QCQJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    const storage = getStorage();

    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const registerBtn = document.getElementById('register-btn');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const displayNameInput = document.getElementById('display-name');
    const profilePhotoInput = document.getElementById('profile-photo');
    const updateProfileBtn = document.getElementById('update-profile-btn');
    const messageInput = document.getElementById('message');
    const sendBtn = document.getElementById('send-btn');
    const chatBox = document.getElementById('chat-box');
    const profileSection = document.querySelector('.profile');
    const chatSection = document.querySelector('.chat');

    registerBtn.onclick = () => {
      createUserWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));
    };

    loginBtn.onclick = () => {
      signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));
    };

    logoutBtn.onclick = () => {
      signOut(auth);
    };

    updateProfileBtn.onclick = async () => {
      const file = profilePhotoInput.files[0];
      let photoURL = auth.currentUser.photoURL;

      if (file) {
        const storageRef = ref(storage, 'profiles/' + auth.currentUser.uid);
        await uploadBytes(storageRef, file);
        photoURL = await getDownloadURL(storageRef);
      }

      updateProfile(auth.currentUser, {
        displayName: displayNameInput.value || auth.currentUser.displayName,
        photoURL: photoURL
      }).then(() => alert('Profile updated'));
    };

    sendBtn.onclick = async () => {
      const user = auth.currentUser;
      if (user && messageInput.value.trim()) {
        await addDoc(collection(db, "messages"), {
          text: messageInput.value,
          createdAt: Date.now(),
          uid: user.uid,
          name: user.displayName || "Anonymous",
          photo: user.photoURL || ""
        });
        messageInput.value = "";
      }
    };

    const renderMessage = msg => {
      const div = document.createElement('div');
      div.className = 'message';
      div.innerHTML = `
        <img src="${msg.photo || 'https://via.placeholder.com/40'}" />
        <strong>${msg.name}</strong>: ${msg.text}
      `;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        logoutBtn.classList.remove('hidden');
        profileSection.classList.remove('hidden');
        chatSection.classList.remove('hidden');
        displayNameInput.value = user.displayName || "";

        const q = query(collection(db, "messages"), orderBy("createdAt"));
        onSnapshot(q, snapshot => {
          chatBox.innerHTML = "";
          snapshot.forEach(doc => renderMessage(doc.data()));
        });

      } else {
        logoutBtn.classList.add('hidden');
        profileSection.classList.add('hidden');
        chatSection.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
